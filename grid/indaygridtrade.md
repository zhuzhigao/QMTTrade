# QMT 智能网格与趋势防御策略 (v2.2 健壮版) - 技术白皮书

**版本**: v2.2 (Robust / Cross-Timezone Edition)
**适用环境**: 光大证券/国金证券 QMT (极简模式 XtQuant)
**运行模式**: 模拟仿真 (Paper Trading) - *只记账，不报单*
**核心优势**: 强制北京时间校准、跨日自动轮转、断点续传保护、数据新鲜度检查。

---

## 1. 系统架构与运行机制 (System Architecture)

### 1.1 跨时区与时间基准
* **核心痛点**: 解决运行机器在海外（如美东时区）导致的时间判断错误。
* **解决方案**: 定义 `BJ_TZ = UTC+8`。所有涉及日期、时间、文件名生成的逻辑，**强制转换为北京时间**。
* **效果**: 无论服务器在哪，策略均严格按照 A 股交易时间运行。

### 1.2 无人值守与自动轮转
* **跨日逻辑**: 程序在死循环中每轮都会检查 `current_date`。
    * 一旦检测到北京时间进入新的一天，自动重置“每日已用额度”，并生成新的 JSON 状态文件和 Log 日志文件。
    * **意义**: 实现 7x24 小时无人值守运行，无需每天重启。

### 1.3 数据健壮性 (Robustness)
* **断点续传**:
    * **移动止盈修复**: 不再依赖内存记录，而是直接读取 Tick 数据的 `high` (今日最高价) 计算真实回撤。重启后，策略依然知道今天最高涨到了多少，不会导致止盈失效。
* **新鲜度检查**:
    * 计算数据时间戳与当前时间的差值。如果滞后超过 **120秒** (网络卡顿或行情中断)，暂停该股交易，防止基于过期价格下单。

---

## 2. 全局风控防线 (Global Risk Control)

在进入具体股票判断前，必须通过的三道环境安检。

### 2.1 时间过滤器 (Time Filter)
* **有效交易时段**:
    * **09:35** ~ 11:30 (避开开盘前 5 分钟的剧烈波动与诱多诱空)
    * 13:00 ~ **14:55** (避开尾盘集合竞价)
* **行为**: 非交易时段仅监控心跳，不执行买卖逻辑。

### 2.2 大盘熔断 (Market Circuit Breaker)
* **标的**: 上证指数 (000001.SH)
* **阈值**: 跌幅 < **-2.5%**
* **行为**: 进入“熔断模式”。
    * **买入**: **禁止** (覆巢之下无完卵)。
    * **卖出**: **允许** (且鼓励) 止盈止损。

### 2.3 资金总阀 (Capital Gate)
* **每日限额**: 每日累计买入金额不超过 **100,000 元** (可配置)。
* **现金检查**: 每次下单前查询券商账户 `Available Cash`，确保有钱可买。

---

## 3. 卖出决策逻辑 (Sell Logic)

**优先级**: 最高 (高于买入)。
**前置**: `今日未卖出过` 且 `持有 T+1 可用仓位`。

| 优先级 | 类型 | 触发条件 | 逻辑说明 |
| :--- | :--- | :--- | :--- |
| **1** | **总仓止盈** | 累计收益率 > **+20%** | 战略级硬止盈，落袋为安。 |
| **2** | **总仓止损** | 累计收益率 < **-15%** | 战略级硬止损，防止深套。 |
| **3** | **移动止盈** | (今日最高涨幅 > **2*ATR**) <br>且 (从最高点回撤 > **0.5%**) | **捕捉主升浪**。<br>v2.2 使用 `Tick['high']` 计算最高涨幅，重启不丢失记忆。 |
| **4** | **ATR止损** | 今日跌幅 < **-2*ATR** <br>且 未达到抄底线 (-6%) | 日内趋势坏死，及时截断亏损。 |

---

## 4. 买入决策逻辑 (Buy Logic)

**优先级**: 次高。
**前置**: `今日未买入过` 且 `大盘未熔断`。
**触发**: 当日跌幅 < **-6%** (深跌抄底)。

只有**同时通过**以下四道“安检门”，才会执行买入：

1.  **非跌停检查**:
    * 买一量 (Bid Vol) 必须 > 0。
    * 跌幅未接近跌停板 (主板 > -9.8%，科创 > -19.8%)。
    * *目的*: 拒绝接飞刀。
2.  **持仓上限 (Position Limit)**:
    * 计算: `(该股市值 + 拟买入金额) / 总资产`
    * 阈值: 必须 < **30%**。
    * *目的*: 防止单只股票仓位过重。
3.  **每日额度**:
    * 剩余额度必须 > 本次买入金额。
4.  **账户现金**:
    * 可用资金必须 > 本次买入金额。

---

## 5. 文件与状态管理

### 5.1 状态记忆 (Persistence)
* **文件名**: `sim_v2_state_YYYY-MM-DD.json` (日期为北京时间)
* **内容结构**:
    ```json
    {
        "daily_buy_total": 52000.0,  // 今日已买总金额
        "stocks": {
            "600519.SH": {
                "bought": 1,         // 1=今日已买
                "sold": 0            // 0=今日未卖
            }
        }
    }
    ```

### 5.2 交易日志 (Logging)
* **文件名**: `sim_v2_trade_log.txt`
* **记录格式**: `[YYYY-MM-DD HH:MM:SS] [BJ] 动作 | 代码 | 价格 | 说明`
* **特点**: 每一条日志都带有时区标记 `[BJ]`，方便回溯。

---

## 6. 核心参数配置速查

| 参数常量 | 默认值 | 解释 |
| :--- | :--- | :--- |
| `BJ_TZ` | UTC+8 | **强制北京时区**，核心修正项 |
| `MAX_DAILY_BUY_AMOUNT` | 100,000 | 每日买入限额 (元) |
| `SINGLE_STOCK_LIMIT_PCT`| 0.30 | 单只持仓上限 (30%) |
| `HOLD_PROFIT_PCT` | 0.20 | 总仓止盈 (+20%) |
| `HOLD_LOSS_PCT` | -0.15 | 总仓止损 (-15%) |
| `TRAILING_DRAWDOWN` | 0.005 | 移动止盈回撤 (0.5%) |
| `BUY_DIP_PCT` | -0.06 | 抄底触发线 (-6%) |
| `ATR_MULTIPLIER` | 2.0 | ATR 倍数 (日内风控宽容度) |

# 金阳光 QMT 策略核心参数推荐表

| 变量名 | 稳健型 (推荐) | 激进型 (妖股模式) | 保守型 (大白马) | 参数说明 |
| :--- | :--- | :--- | :--- | :--- |
| **BUY_DIP_PCT** | -0.05 | -0.07 | -0.04 | **抄底阈值**：触发买入的下跌百分比（如-0.05代表-5%） |
| **TRAILING_DRAWDOWN** | 0.02 | 0.03 | 0.015 | **追踪止损**：自最高点回撤此比例则卖出 |
| **ATR_MULTIPLIER** | 2.5 | 3.0 | 2.0 | **ATR倍数**：决定日内波动的容忍度 |
| **HOLD_PROFIT_PCT** | 0.15 | 0.30 | 0.10 | **止盈目标**：持仓盈利达到此比例触发止盈逻辑 |
| **HOLD_LOSS_PCT** | -0.10 | -0.15 | -0.07 | **止损硬封顶**：持仓亏损达到此比例强制平仓 |
| **SINGLE_STOCK_LIMIT** | 0.20 | 0.50 | 0.10 | **单仓上限**：单只股票占用总资金的最大比例 |
| **BENCHMARK_RISK** | -0.02 | -0.03 | -0.015 | **大盘熔断线**：基准指数跌幅超限则全线停止开仓 |

---

### 💡 专家调参提示（针对账号 47601131）

1. **ATR 动态调整**：在 QMT 中建议配合 `ContextInfo.get_market_data` 获取 `ATR` 指标，自动根据市场波动率缩放止损位。
2. **极简模式对接**：在使用 `xtquant` 时，可将上述数值存入一个 `dict` 字典，方便策略根据市场环境一键切换配置。
3. **滑点建议**：日线级别策略建议在代码中预留 **0.1% - 0.2%** 的滑点空间，以抵消极简模式下实盘成交的冲击成本。